<div class="saved-payment-methods">
  <div class="page-header">
    <div>
      <h2>Saved Payment Methods</h2>
      <p class="subtitle">Manage your saved cards for faster checkout</p>
    </div>
    <button (click)="openAddMethodModal()" class="btn btn--primary">
      <span>‚ûï</span>
      <span>Add Payment Method</span>
    </button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading payment methods...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <div class="alert alert--error">
      <span>‚ö†Ô∏è</span>
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && paymentMethods().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üí≥</div>
      <h3>No Saved Payment Methods</h3>
      <p>Add a payment method to make checkout faster and easier.</p>
      <button (click)="openAddMethodModal()" class="btn btn--primary">
        Add Your First Card
      </button>
    </div>
  }

  <!-- Payment Methods List -->
  @if (!loading() && !error() && paymentMethods().length > 0) {
    <div class="payment-methods-grid">
      @for (method of paymentMethods(); track method.id) {
        <div class="payment-card" [class.payment-card--default]="method.isDefault">
          <!-- Card Header -->
          <div class="card-header">
            <div class="card-brand">
              <span class="brand-icon">{{ getCardBrandIcon(method.brand) }}</span>
              <span class="brand-name">{{ getCardBrandName(method.brand) }}</span>
            </div>
            @if (method.isDefault) {
              <span class="default-badge">Default</span>
            }
          </div>

          <!-- Card Number -->
          <div class="card-number">
            {{ formatCardNumber(method.last4) }}
          </div>

          <!-- Card Details -->
          <div class="card-details">
            <div class="detail-item">
              <span class="detail-label">Expires</span>
              <span class="detail-value">
                {{ formatExpiryDate(method.expiryMonth, method.expiryYear) }}
              </span>
            </div>
            @if (method.holderName) {
              <div class="detail-item">
                <span class="detail-label">Cardholder</span>
                <span class="detail-value">{{ method.holderName }}</span>
              </div>
            }
          </div>

          <!-- Expiry Warning -->
          @if (isExpired(method.expiryMonth, method.expiryYear)) {
            <div class="expiry-warning expiry-warning--expired">
              ‚ö†Ô∏è This card has expired
            </div>
          } @else if (isExpiringSoon(method.expiryMonth, method.expiryYear)) {
            <div class="expiry-warning expiry-warning--soon">
              ‚ö†Ô∏è Expiring soon
            </div>
          }

          <!-- Card Actions -->
          <div class="card-actions">
            @if (!method.isDefault) {
              <button
                (click)="onSetDefault(method)"
                class="btn btn--secondary btn--sm"
                title="Set as default payment method"
              >
                Set as Default
              </button>
            }
            <button
              (click)="openDeleteModal(method)"
              class="btn btn--danger btn--sm"
              title="Delete payment method"
            >
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal()) {
    <div class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Delete Payment Method</h3>
          <button (click)="closeDeleteModal()" class="modal-close">&times;</button>
        </div>

        <div class="modal-body">
          @if (methodToDelete()) {
            <p>Are you sure you want to delete this payment method?</p>
            <div class="method-preview">
              <span class="brand-icon">{{ getCardBrandIcon(methodToDelete()!.brand) }}</span>
              <span>{{ getCardBrandName(methodToDelete()!.brand) }} ending in {{ methodToDelete()!.last4 }}</span>
            </div>
            @if (methodToDelete()!.isDefault) {
              <div class="alert alert--warning">
                <span>‚ö†Ô∏è</span>
                <span>This is your default payment method. Another card will be set as default if available.</span>
              </div>
            }
          }
        </div>

        <div class="modal-footer">
          <button
            (click)="closeDeleteModal()"
            class="btn btn--secondary"
            [disabled]="deleting()"
          >
            Cancel
          </button>
          <button
            (click)="confirmDelete()"
            class="btn btn--danger"
            [disabled]="deleting()"
          >
            @if (deleting()) {
              <span class="spinner-sm"></span>
              <span>Deleting...</span>
            } @else {
              <span>Delete</span>
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Add Payment Method Modal -->
  @if (showAddMethodModal()) {
    <div class="modal-overlay" (click)="closeAddMethodModal()">
      <div class="modal-content modal-content--large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Add Payment Method</h3>
          <button (click)="closeAddMethodModal()" class="modal-close">&times;</button>
        </div>

        <div class="modal-body">
          <p class="info-text">This feature requires Stripe integration to add new payment methods. In a production environment, a Stripe Elements form would appear here.</p>
          <div class="alert alert--info">
            <span>‚ÑπÔ∏è</span>
            <span>New payment methods can be added during checkout and saved for future use.</span>
          </div>
        </div>

        <div class="modal-footer">
          <button (click)="closeAddMethodModal()" class="btn btn--secondary">
            Close
          </button>
        </div>
      </div>
    </div>
  }
</div>
