<div class="booking-page">
  <div class="container">
    @if (error() && !hotel()) {
      <div class="alert alert--error">
        <span>‚ö†Ô∏è</span>
        <span>{{ error() }}</span>
      </div>
      <a routerLink="/hotels" class="btn btn--primary">Back to Hotels</a>
    }

    @if (hotel() && !success() && paymentStep() !== 'confirmation') {
      <div class="booking-container">
        @if (paymentStep() === 'booking') {
          <div class="booking-content">
            <div class="booking-header">
              <h1 class="booking-header__title">Complete Your Booking</h1>
              <p class="booking-header__subtitle">
                You're just one step away from your perfect stay
              </p>
            </div>

          <div class="hotel-summary">
            <img
              [src]="hotel()!.images[0]"
              [alt]="hotel()!.name"
              class="hotel-summary__image"
              (error)="onImageError($event)"
              loading="lazy"
            />
            <div class="hotel-summary__details">
              <h2 class="hotel-summary__name">{{ hotel()!.name }}</h2>
              <p class="hotel-summary__location">üìç {{ hotel()!.location }}</p>
              <div class="hotel-summary__rating">
                <span class="stars">‚≠ê {{ hotel()!.starRating }}</span>
                @if (hotel()!.averageRating) {
                  <span class="rating">{{ hotel()!.averageRating }}/5</span>
                }
              </div>
              <p class="hotel-summary__price">
                ${{ hotel()!.pricePerNight }} <span>per night</span>
              </p>
            </div>
          </div>

          <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" class="booking-form">
            <!-- Room Selection Section -->
            <div class="room-selection-section">
              <h3 class="form-section-title">Select Your Room</h3>

              @if (availableRooms().length > 0) {
                <div class="rooms-grid">
                  @for (room of hotel()!.rooms; track room.id) {
                    <div
                      class="room-card"
                      [class.room-card--selected]="bookingForm.value.roomId === room.id"
                      [class.room-card--unavailable]="!room.available"
                    >
                      <div class="room-card__header">
                        <h4 class="room-card__title">{{ room.roomType }}</h4>
                        @if (!room.available) {
                          <span class="room-card__badge room-card__badge--unavailable">Unavailable</span>
                        }
                      </div>

                      <div class="room-card__details">
                        <div class="room-card__info">
                          <span class="room-card__icon">üë•</span>
                          <span>Up to {{ room.capacity }} guests</span>
                        </div>
                        <div class="room-card__price">
                          <span class="price-amount">${{ room.pricePerNight }}</span>
                          <span class="price-period">per night</span>
                        </div>
                      </div>

                      @if (room.amenities && room.amenities.length > 0) {
                        <div class="room-card__amenities">
                          @for (amenity of room.amenities.slice(0, 3); track amenity) {
                            <span class="amenity-tag">{{ amenity }}</span>
                          }
                          @if (room.amenities.length > 3) {
                            <span class="amenity-tag amenity-tag--more">+{{ room.amenities.length - 3 }} more</span>
                          }
                        </div>
                      }

                      <button
                        type="button"
                        class="room-card__select-btn"
                        [class.room-card__select-btn--selected]="bookingForm.value.roomId === room.id"
                        [disabled]="!room.available"
                        (click)="bookingForm.patchValue({ roomId: room.id })"
                      >
                        @if (bookingForm.value.roomId === room.id) {
                          <span>‚úì Selected</span>
                        } @else if (!room.available) {
                          <span>Unavailable</span>
                        } @else {
                          <span>Select Room</span>
                        }
                      </button>
                    </div>
                  }
                </div>

                @if (bookingForm.get('roomId')?.invalid && bookingForm.get('roomId')?.touched) {
                  <span class="form-error">Please select a room type</span>
                }
              } @else {
                <div class="alert alert--warning">
                  <span>‚ö†Ô∏è</span>
                  <span>No rooms are currently available for this hotel.</span>
                </div>
              }
            </div>

            <h3 class="form-section-title">Select Your Dates</h3>

            <!-- Availability Calendar -->
            <div class="calendar-section">
              <app-availability-calendar
                [pricePerNight]="selectedRoom()?.pricePerNight || hotel()!.pricePerNight"
                [initialCheckIn]="initialCheckIn()"
                [initialCheckOut]="initialCheckOut()"
                [showPrice]="true"
                (dateRangeSelected)="onDateRangeSelected($event)"
                (dateRangeCleared)="onDateRangeCleared()"
              ></app-availability-calendar>

              @if ((bookingForm.get('checkIn')?.invalid && bookingForm.get('checkIn')?.touched) ||
                   (bookingForm.get('checkOut')?.invalid && bookingForm.get('checkOut')?.touched)) {
                <span class="form-error">Please select check-in and check-out dates</span>
              }
            </div>

            <div class="form-group">
              <label for="guests" class="form-label">
                Number of Guests
                <span class="required">*</span>
              </label>
              <input
                type="number"
                id="guests"
                formControlName="guests"
                min="1"
                max="10"
                class="form-input"
                [class.form-input--error]="bookingForm.get('guests')?.invalid && bookingForm.get('guests')?.touched"
              />
              @if (bookingForm.get('guests')?.invalid && bookingForm.get('guests')?.touched) {
                <span class="form-error">Please enter a valid number of guests (1-10)</span>
              }
            </div>

            <div class="form-group">
              <label for="specialRequests" class="form-label">
                Special Requests (Optional)
              </label>
              <textarea
                id="specialRequests"
                formControlName="specialRequests"
                rows="4"
                placeholder="Any special requirements or requests?"
                class="form-textarea"
              ></textarea>
            </div>

            @if (error()) {
              <div class="alert alert--error">
                <span>‚ö†Ô∏è</span>
                <span>{{ error() }}</span>
              </div>
            }

            <div class="form-actions">
              <a routerLink="/hotels" class="btn btn--secondary">Cancel</a>
              <button
                type="submit"
                class="btn btn--primary"
                [disabled]="loading() || bookingForm.invalid"
              >
                @if (loading()) {
                  <span>Processing...</span>
                } @else {
                  <span>Continue to Payment</span>
                }
              </button>
            </div>
          </form>
        </div>

        <div class="booking-sidebar">
          <div class="price-summary">
            <h3 class="price-summary__title">Price Summary</h3>

            @if (selectedRoom()) {
              <div class="price-summary__detail">
                <span class="detail-label">Room Type</span>
                <span class="detail-value">{{ selectedRoom()!.roomType }}</span>
              </div>

              @if (calculateNights() > 0) {
                <div class="price-summary__row">
                  <span>${{ selectedRoom()!.pricePerNight }} √ó {{ calculateNights() }} nights</span>
                  <span>${{ selectedRoom()!.pricePerNight * calculateNights() }}</span>
                </div>

                @if (pointsDiscount() > 0) {
                  <div class="price-summary__row price-summary__row--discount">
                    <span>Points Discount</span>
                    <span class="discount-value">-${{ pointsDiscount().toFixed(2) }}</span>
                  </div>
                }

                <div class="price-summary__divider"></div>

                <div class="price-summary__total">
                  <span>Total</span>
                  <span>${{ calculateFinalPrice().toFixed(2) }}</span>
                </div>
              } @else {
                <p class="price-summary__note">
                  Select your dates to see the total price
                </p>
              }
            } @else {
              <p class="price-summary__note">
                Select a room to see pricing details
              </p>
            }
          </div>

          <!-- Loyalty Points Redemption -->
          @if (calculateNights() > 0 && selectedRoom()) {
            <app-points-redemption
              [bookingAmount]="calculateTotalPrice()"
              (pointsChanged)="onPointsRedemptionChange($event)"
            ></app-points-redemption>
          }

          <div class="booking-info">
            <h4 class="booking-info__title">Good to know</h4>
            <ul class="booking-info__list">
              <li>‚úì Free cancellation up to 24 hours before check-in</li>
              <li>‚úì Secure payment with Stripe</li>
              <li>‚úì Full refund if cancelled 24+ hours before</li>
            </ul>
          </div>
        </div>
        }

        @if (paymentStep() === 'payment') {
          <div class="payment-container-wrapper">
            <div class="payment-header">
              <button type="button" (click)="goBackToBooking()" class="btn-back">‚Üê Back to Booking</button>
              <h1>Payment Details</h1>
            </div>

            <div class="payment-content">
              <!-- Booking Summary -->
              <div class="booking-summary-card">
                <h3>Booking Summary</h3>
                <div class="summary-row">
                  <span class="label">Hotel:</span>
                  <span class="value">{{ hotel()!.name }}</span>
                </div>
                <div class="summary-row">
                  <span class="label">Room:</span>
                  <span class="value">{{ selectedRoom()!.roomType }}</span>
                </div>
                <div class="summary-row">
                  <span class="label">Check-in:</span>
                  <span class="value">{{ bookingForm.value.checkIn }}</span>
                </div>
                <div class="summary-row">
                  <span class="label">Check-out:</span>
                  <span class="value">{{ bookingForm.value.checkOut }}</span>
                </div>
                <div class="summary-row">
                  <span class="label">Guests:</span>
                  <span class="value">{{ bookingForm.value.guests }}</span>
                </div>
                <div class="summary-row">
                  <span class="label">Nights:</span>
                  <span class="value">{{ calculateNights() }}</span>
                </div>
                <div class="summary-row">
                  <span class="label">Subtotal:</span>
                  <span class="value">${{ calculateTotalPrice().toFixed(2) }}</span>
                </div>
                @if (pointsDiscount() > 0) {
                  <div class="summary-row discount">
                    <span class="label">Points Discount:</span>
                    <span class="value discount-value">-${{ pointsDiscount().toFixed(2) }}</span>
                  </div>
                }
                <div class="summary-row total">
                  <span class="label">Total:</span>
                  <span class="value">${{ calculateFinalPrice().toFixed(2) }}</span>
                </div>
              </div>

              <!-- Stripe Payment Component -->
              <app-stripe-payment
                [clientSecret]="paymentIntent()!.clientSecret"
                [amount]="calculateFinalPrice()"
                [savedPaymentMethods]="savedPaymentMethods()"
                [allowSavePaymentMethod]="true"
                (paymentSuccess)="onPaymentSuccess($event)"
                (paymentError)="onPaymentError($event)"
                (savePaymentMethodChange)="savePaymentMethod.set($event)"
                (selectedPaymentMethodChange)="selectedPaymentMethodId.set($event)"
              ></app-stripe-payment>

              @if (paymentError()) {
                <div class="alert alert--error">
                  <span>‚ö†Ô∏è</span>
                  <span>{{ paymentError() }}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    @if (success()) {
      <div class="success-container">
        <div class="success-card">
          <div class="success-icon">‚úì</div>
          <h1 class="success-title">Booking Confirmed!</h1>
          <p class="success-message">
            Your booking has been successfully confirmed.
          </p>

          <div class="confirmation-details">
            <div class="confirmation-row">
              <span class="label">Confirmation Number:</span>
              <span class="value">{{ confirmationNumber() }}</span>
            </div>
            <div class="confirmation-row">
              <span class="label">Hotel:</span>
              <span class="value">{{ hotel()!.name }}</span>
            </div>
            <div class="confirmation-row">
              <span class="label">Check-in:</span>
              <span class="value">{{ bookingForm.value.checkIn }}</span>
            </div>
            <div class="confirmation-row">
              <span class="label">Check-out:</span>
              <span class="value">{{ bookingForm.value.checkOut }}</span>
            </div>
            <div class="confirmation-row">
              <span class="label">Guests:</span>
              <span class="value">{{ bookingForm.value.guests }}</span>
            </div>
            @if (pointsDiscount() > 0) {
              <div class="confirmation-row">
                <span class="label">Points Discount:</span>
                <span class="value discount-value">-${{ pointsDiscount().toFixed(2) }}</span>
              </div>
            }
            <div class="confirmation-row total">
              <span class="label">Total Amount:</span>
              <span class="value">${{ calculateFinalPrice().toFixed(2) }}</span>
            </div>
          </div>

          <p class="success-note">
            A confirmation email and payment receipt have been sent to your email address.
          </p>

          <div class="success-actions">
            <button (click)="goToDashboard()" class="btn btn--primary">
              View My Bookings
            </button>
            <a routerLink="/hotels" class="btn btn--secondary">
              Browse More Hotels
            </a>
          </div>
        </div>
      </div>
    }
  </div>
</div>
