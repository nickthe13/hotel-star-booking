@if (loading()) {
  <app-loader />
} @else if (hotel()) {
  <div class="hotel-details">
    <!-- Breadcrumb -->
    <div class="container">
      <nav class="breadcrumb">
        <a routerLink="/home">Home</a>
        <span class="breadcrumb__separator">/</span>
        <a routerLink="/hotels">Hotels</a>
        <span class="breadcrumb__separator">/</span>
        <span class="breadcrumb__current">{{ hotel()!.name }}</span>
      </nav>
    </div>

    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <div class="hero__content">
          <div class="hero__header">
            <h1 class="hero__title">{{ hotel()!.name }}</h1>
            <button
              type="button"
              class="hero__favorite-btn"
              [class.hero__favorite-btn--active]="isFavorite"
              (click)="toggleFavorite()"
              [title]="isFavorite ? 'Remove from favorites' : 'Add to favorites'"
            >
              <svg viewBox="0 0 24 24" width="28" height="28">
                @if (isFavorite) {
                  <path
                    fill="currentColor"
                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                  />
                } @else {
                  <path
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                  />
                }
              </svg>
              <span>{{ isFavorite ? 'Saved' : 'Save' }}</span>
            </button>
          </div>
          <div class="hero__meta">
            <div class="star-rating">
              @for (star of [1, 2, 3, 4, 5]; track star) {
                <span [class.filled]="star <= hotel()!.starRating">&#9733;</span>
              }
            </div>
            <span class="location">{{ hotel()!.location }}</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Image Gallery -->
    <section class="gallery">
      <div class="container">
        <div class="gallery__main">
          <img
            [src]="hotel()!.images[selectedImageIndex()]"
            [alt]="hotel()!.name"
            class="gallery__main-image"
          />
        </div>
        <div class="gallery__thumbnails">
          @for (image of hotel()!.images; track $index) {
            <button
              class="gallery__thumbnail"
              [class.gallery__thumbnail--active]="selectedImageIndex() === $index"
              (mouseenter)="selectImage($index)"
            >
              <img [src]="image" [alt]="hotel()!.name + ' - Image ' + ($index + 1)" />
            </button>
          }
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <div class="container">
      <div class="content-layout">
        <!-- Main Info -->
        <main class="main-content">
          <!-- Description -->
          <section class="section">
            <h2 class="section__title">About This Hotel</h2>
            <p class="section__text">{{ hotel()!.description }}</p>
          </section>

          <!-- Amenities -->
          <section class="section">
            <h2 class="section__title">Amenities</h2>
            <div class="amenities-grid">
              @for (amenity of hotel()!.amenities; track amenity) {
                <div class="amenity-item">
                  <span class="amenity-item__icon">‚úì</span>
                  <span class="amenity-item__text">{{ amenity }}</span>
                </div>
              }
            </div>
          </section>

          <!-- Available Rooms -->
          @if ((hotel()?.rooms?.length ?? 0) > 0) {
            <section class="section">
              <h2 class="section__title">Available Rooms</h2>
              <div class="rooms-list">
                @for (room of hotel()!.rooms; track room.id) {
                  <div
                    class="room-card"
                    [class.room-card--unavailable]="!room.available"
                    [class.room-card--selected]="isRoomSelected(room)"
                    [class.room-card--selectable]="room.available"
                    (click)="selectRoom(room)"
                  >
                    <div class="room-card__header">
                      <h3 class="room-card__title">{{ room.roomType }}</h3>
                      @if (!room.available) {
                        <span class="room-card__badge room-card__badge--unavailable">Unavailable</span>
                      } @else if (isRoomSelected(room)) {
                        <span class="room-card__badge room-card__badge--selected">Selected</span>
                      } @else {
                        <span class="room-card__badge room-card__badge--available">Available</span>
                      }
                    </div>

                    <div class="room-card__content">
                      <div class="room-card__info">
                        <div class="info-item">
                          <span class="info-item__icon">üë•</span>
                          <span class="info-item__text">Up to {{ room.capacity }} guests</span>
                        </div>
                        <div class="info-item">
                          <span class="info-item__icon">üí∞</span>
                          <span class="info-item__text">${{ room.pricePerNight }} per night</span>
                        </div>
                      </div>

                      @if (room.amenities && room.amenities.length > 0) {
                        <div class="room-card__amenities">
                          <h4 class="amenities-title">Room Amenities:</h4>
                          <div class="amenities-tags">
                            @for (amenity of room.amenities.slice(0, 4); track amenity) {
                              <span class="amenity-tag">{{ amenity }}</span>
                            }
                            @if (room.amenities.length > 4) {
                              <span class="amenity-tag amenity-tag--more">+{{ room.amenities.length - 4 }} more</span>
                            }
                          </div>
                        </div>
                      }


                    </div>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Reviews -->
          <section class="section">
            <div class="section__header">
              <h2 class="section__title">Guest Reviews</h2>
              @if (authService.isAuthenticated()) {
                <button class="btn btn--primary" (click)="openReviewModal()" type="button">
                  @if (userReview()) {
                    ‚úèÔ∏è Edit My Review
                  } @else {
                    ‚úçÔ∏è Write a Review
                  }
                </button>
              } @else {
                <a routerLink="/auth/login" class="btn btn--primary">Sign in to Review</a>
              }
            </div>

            @if (hotel()!.averageRating && hotel()!.totalReviews) {
              <div class="reviews-summary">
                <div class="reviews-summary__score">
                  <span class="score">{{ hotel()!.averageRating }}</span>
                  <span class="score-label">Excellent</span>
                </div>
                <div class="reviews-summary__info">
                  <p>Based on {{ hotel()!.totalReviews }} verified reviews</p>
                </div>
              </div>
            }

            <!-- Reviews List -->
            <div class="reviews-container">
              <app-review-list
                [reviews]="reviews()"
                [loading]="reviewsLoading()"
                (onEdit)="editReview($event)"
                (onDelete)="deleteReview($event)"
              ></app-review-list>
            </div>
          </section>

          <!-- Location -->
          <section class="section">
            <h2 class="section__title">Location</h2>
            <p class="location-text">
              üìç {{ hotel()!.location }}, {{ hotel()!.city }}, {{ hotel()!.country }}
            </p>
            <div class="map-placeholder">
              <p>Map view coming soon</p>
            </div>
          </section>
        </main>

        <!-- Booking Card -->
        <aside class="booking-card" #bookingCard>
          <div class="booking-card__content">
            <div class="booking-card__price">
              <span class="price-label">From</span>
              <span class="price-amount">${{ selectedRoom()?.pricePerNight ?? hotel()!.pricePerNight }}</span>
              <span class="price-period">per night</span>
            </div>

            @if (hotel()!.averageRating) {
              <div class="booking-card__rating">
                <span class="rating-score">{{ hotel()!.averageRating }}</span>
                <div class="rating-info">
                  <span class="rating-label">Excellent</span>
                  <span class="rating-reviews">{{ hotel()!.totalReviews }} reviews</span>
                </div>
              </div>
            }

            <!-- Booking Stepper -->
            <app-booking-stepper
              [hotel]="hotel()!"
              [selectedRoom]="selectedRoom()"
              [checkIn]="selectedCheckIn()"
              [checkOut]="selectedCheckOut()"
              (dateRangeSelected)="onDateRangeSelected($event)"
              (dateRangeCleared)="onDateRangeCleared()"
              (confirmBooking)="onConfirmBooking($event)"
            ></app-booking-stepper>

            <div class="booking-card__features">
              <div class="feature">
                <span class="feature__icon">‚úì</span>
                <span class="feature__text">Free cancellation</span>
              </div>
              <div class="feature">
                <span class="feature__icon">‚úì</span>
                <span class="feature__text">Best price guarantee</span>
              </div>
              <div class="feature">
                <span class="feature__icon">‚úì</span>
                <span class="feature__text">Instant confirmation</span>
              </div>
            </div>

            <!-- Book Now Button - appears after dates are selected -->
            @if (selectedCheckIn() && selectedCheckOut()) {
              <div class="booking-card__action">
                <button
                  class="btn btn--primary btn--large btn--full"
                  (click)="onBookNowClick()"
                  type="button"
                >
                  @if (selectedRoom()) {
                    Book Now
                  } @else {
                    Select a Room to Continue
                  }
                </button>
                @if (!selectedRoom()) {
                  <p class="booking-card__hint">Please select a room from the list above</p>
                }
              </div>
            }
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <app-modal
    [title]="userReview() ? 'Edit Your Review' : 'Write a Review'"
    [isOpen]="showReviewModal()"
    size="md"
    (onClose)="closeReviewModal()"
  >
    <app-review-form
      [hotelId]="id"
      [existingReview]="editingReview()"
      [submitButtonText]="userReview() ? 'Update Review' : 'Submit Review'"
      (onSubmit)="submitReview($event)"
      (onCancel)="closeReviewModal()"
    ></app-review-form>
  </app-modal>

  <!-- Payment Modal -->
  <app-payment-modal
    [isOpen]="showPaymentModal()"
    [bookingData]="paymentModalData()"
    (closeModal)="closePaymentModal()"
    (bookingComplete)="onBookingComplete($event)"
  ></app-payment-modal>
} @else {
  <div class="container">
    <div class="error-message">
      <h2>Hotel Not Found</h2>
      <p>The hotel you're looking for doesn't exist.</p>
      <a routerLink="/hotels" class="btn btn--primary">Browse Hotels</a>
    </div>
  </div>
}
