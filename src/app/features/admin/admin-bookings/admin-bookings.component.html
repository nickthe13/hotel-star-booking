@if (loading()) {
  <div class="bookings-loading">
    <div class="spinner"></div>
    <p>Loading bookings...</p>
  </div>
} @else {
  <div class="bookings">
    <div class="bookings__header">
      <div>
        <h2 class="bookings__title">Bookings Management</h2>
        <p class="bookings__subtitle">Manage all customer bookings</p>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters">
      <div class="filters__row">
        <!-- Search Input -->
        <div class="filter-group">
          <label for="search" class="filter-group__label">Search</label>
          <input
            id="search"
            type="text"
            class="filter-group__input"
            placeholder="Search by hotel, location, or booking ID..."
            [value]="searchQuery()"
            (input)="onSearchChange($event)"
          />
        </div>

        <!-- Status Filter -->
        <div class="filter-group">
          <label for="status-filter" class="filter-group__label">Status</label>
          <select
            id="status-filter"
            class="filter-group__select"
            [value]="statusFilter()"
            (change)="onStatusFilterChange($event)"
          >
            <option value="all">All Statuses</option>
            <option [value]="BookingStatus.PENDING">Pending</option>
            <option [value]="BookingStatus.CONFIRMED">Confirmed</option>
            <option [value]="BookingStatus.COMPLETED">Completed</option>
            <option [value]="BookingStatus.CANCELLED">Cancelled</option>
          </select>
        </div>

        <!-- Clear Filters Button -->
        <div class="filter-group">
          <label class="filter-group__label">&nbsp;</label>
          <button
            type="button"
            class="btn btn--secondary"
            (click)="clearFilters()"
          >
            Clear Filters
          </button>
        </div>
      </div>

      <!-- Results Summary -->
      <div class="filters__summary">
        Showing <strong>{{ filteredBookings().length }}</strong> of <strong>{{ allBookings().length }}</strong> bookings
      </div>
    </div>

    <!-- Bookings Table -->
    <div class="bookings__table">
      @if (filteredBookings().length > 0) {
        <app-table
          [data]="filteredBookings()"
          [columns]="columns"
          [actions]="actions"
        ></app-table>
      } @else {
        <div class="empty-state">
          <div class="empty-state__icon">ðŸ“‹</div>
          <h3 class="empty-state__title">No bookings found</h3>
          <p class="empty-state__message">
            @if (searchQuery() || statusFilter() !== 'all') {
              Try adjusting your filters to see more results.
            } @else {
              No bookings have been made yet.
            }
          </p>
        </div>
      }
    </div>
  </div>
}

<!-- Status Update Modal -->
<app-modal
  [isOpen]="showStatusModal()"
  [title]="'Update Booking Status'"
  (onClose)="closeStatusModal()"
>
  <form [formGroup]="statusForm" (ngSubmit)="updateBookingStatus()">
    <div class="modal-body">
      @if (selectedBooking(); as booking) {
        <div class="booking-info">
          <h4 class="booking-info__title">Booking #{{ booking.id }}</h4>
          <p class="booking-info__hotel">{{ booking.hotel?.name || 'N/A' }}</p>
          <p class="booking-info__dates">
            {{ formatDate(booking.checkIn) }} - {{ formatDate(booking.checkOut) }}
          </p>
        </div>

        <div class="form-group">
          <label for="status" class="form-group__label">New Status</label>
          <select
            id="status"
            formControlName="status"
            class="form-group__select"
          >
            @for (status of bookingStatuses; track status) {
              <option [value]="status">{{ getStatusLabel(status) }}</option>
            }
          </select>
        </div>
      }
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" (click)="closeStatusModal()">
        Cancel
      </button>
      <button type="submit" class="btn btn--primary">
        Update Status
      </button>
    </div>
  </form>
</app-modal>

<!-- Cancel Booking Confirmation Dialog -->
<app-confirmation-dialog
  [isOpen]="showCancelDialog()"
  [title]="'Cancel Booking'"
  [message]="'Are you sure you want to cancel this booking? This action cannot be undone.'"
  [confirmText]="'Yes, Cancel Booking'"
  [cancelText]="'No, Keep It'"
  [variant]="'danger'"
  (onConfirm)="confirmCancel()"
  (onCancel)="closeCancelDialog()"
></app-confirmation-dialog>

<!-- Refund Modal -->
<app-modal
  [isOpen]="showRefundModal()"
  [title]="'Process Refund'"
  (onClose)="closeRefundModal()"
>
  <form [formGroup]="refundForm" (ngSubmit)="processRefund()">
    <div class="modal-body">
      @if (selectedBooking(); as booking) {
        <div class="booking-info">
          <h4 class="booking-info__title">Booking #{{ booking.id }}</h4>
          <p class="booking-info__hotel">{{ booking.hotel?.name || 'N/A' }}</p>
          <p class="booking-info__dates">
            {{ formatDate(booking.checkIn) }} - {{ formatDate(booking.checkOut) }}
          </p>
          <p class="booking-info__payment">
            <strong>Payment Amount:</strong> {{ formatCurrency(booking.totalPrice) }}
          </p>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="isPartial"
              formControlName="isPartial"
              (change)="onPartialRefundChange($event)"
              class="checkbox-group__input"
            />
            <label for="isPartial" class="checkbox-group__label">
              Partial Refund
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="refund-amount" class="form-group__label">
            Refund Amount
          </label>
          <input
            type="number"
            id="refund-amount"
            formControlName="amount"
            class="form-group__input"
            [readonly]="!refundForm.value.isPartial"
            placeholder="Enter refund amount"
            step="0.01"
            min="0.01"
            [max]="booking.totalPrice"
          />
          @if (refundForm.get('amount')?.touched && refundForm.get('amount')?.invalid) {
            <span class="form-group__error">
              Please enter a valid refund amount
            </span>
          }
        </div>

        <div class="form-group">
          <label for="refund-reason" class="form-group__label">
            Refund Reason
          </label>
          <textarea
            id="refund-reason"
            formControlName="reason"
            class="form-group__textarea"
            placeholder="Enter reason for refund..."
            rows="4"
          ></textarea>
          @if (refundForm.get('reason')?.touched && refundForm.get('reason')?.invalid) {
            <span class="form-group__error">
              Refund reason is required
            </span>
          }
        </div>
      }
    </div>

    <div class="modal-footer">
      <button
        type="button"
        class="btn btn--secondary"
        (click)="closeRefundModal()"
        [disabled]="processingRefund()"
      >
        Cancel
      </button>
      <button
        type="submit"
        class="btn btn--warning"
        [disabled]="processingRefund() || refundForm.invalid"
      >
        @if (processingRefund()) {
          <span>Processing...</span>
        } @else {
          <span>Process Refund</span>
        }
      </button>
    </div>
  </form>
</app-modal>
